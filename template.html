<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | {{{ PRODUCT_NAME }}}</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=AQq_cJJUJlWMNqnCYM0MrD-L_G1rMWGy7vpgBZAVKpSvWlhULR3A7l4Oy_BmU8WLNO6T0VN3YZf8P0gp&currency=USD"></script>
    <style>
        /* Unity WebGL styles */
        body {
            padding: 0;
            margin: 0;
        }

        #unity-container {
            position: absolute;
        }

            #unity-container.unity-desktop {
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
            }

            #unity-container.unity-mobile {
                width: 100%;
                height: 100%;
            }

        #unity-canvas {
            background: #231F20;
        }

        .unity-mobile #unity-canvas {
            width: 100%;
            height: 100%;
        }

        #unity-loading-bar {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        #unity-logo {
            width: 154px;
            height: 130px;
            background: url('TemplateData/unity-logo-dark.png') no-repeat center;
        }

        #unity-progress-bar-empty {
            width: 141px;
            height: 18px;
            margin-top: 10px;
            background: url('TemplateData/progress-bar-empty-dark.png') no-repeat center;
        }

        #unity-progress-bar-full {
            width: 0%;
            height: 18px;
            margin-top: 10px;
            background: url('TemplateData/progress-bar-full-dark.png') no-repeat center;
        }

        #unity-footer {
            position: relative;
        }

        .unity-mobile #unity-footer {
            display: none;
        }

        #unity-webgl-logo {
            float: left;
            width: 204px;
            height: 38px;
            background: url('TemplateData/webgl-logo.png') no-repeat center;
        }

        #unity-build-title {
            float: right;
            margin-right: 10px;
            line-height: 38px;
            font-family: arial;
            font-size: 18px;
        }

        #unity-fullscreen-button {
            background: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            margin-left: 10px;
        }

        #unity-warning {
            position: absolute;
            left: 50%;
            top: 5%;
            transform: translate(-50%);
            background: yellow;
            padding: 5px;
            color: black;
            display: none;
        }

        /* Three-tier authentication overlay */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(35, 35, 35, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
        }

        .auth-content {
            background: #2a2a2a;
            padding: 40px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .auth-title {
            font-size: 24px;
            margin-bottom: 20px;
        }

        .auth-description {
            font-size: 16px;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-btn-primary {
            background: #0070ba;
            color: white;
        }

            .auth-btn-primary:hover {
                background: #005ea6;
            }

        .auth-btn-secondary {
            background: transparent;
            color: #ccc;
            border: 1px solid #666;
        }

            .auth-btn-secondary:hover {
                background: #333;
                color: white;
            }

        .auth-btn-link {
            background: transparent;
            color: #0070ba;
            border: none;
            font-size: 14px;
            text-decoration: underline;
            cursor: pointer;
            margin-top: 10px;
        }

            .auth-btn-link:hover {
                color: #005ea6;
            }

        .paypal-container {
            margin: 20px 0;
        }

        .loading-text {
            margin-top: 20px;
            color: #ccc;
        }

        /* Hide overlay when not needed */
        .hidden {
            display: none !important;
        }

        /* Responsive breakpoints */
        @media (max-width: 960px) {
            #unity-container {
                width: 100vw;
                height: 100vh;
            }
        }
    </style>
</head>
<body>
    <!-- Three-tier Authentication Overlay -->
    <div id="authOverlay" class="auth-overlay hidden">
        <div class="auth-content">
            <div class="auth-title">Creator Content - Support Artists</div>
            <div class="auth-description">
                This experience was created by an independent artist. Support creators by purchasing paid content or continue with free content only.
                (You can reload the page to sign in with PayPal and purchase paid content at any time.)
            </div>
            <div class="auth-buttons">
                <button class="auth-btn auth-btn-primary" onclick="startPayPalLogin()">
                    Support Creator - Enable PayPal Purchases
                </button>
                <div class="paypal-container" id="paypalContainer"></div>
                <button class="auth-btn auth-btn-secondary" onclick="continueAsVisitor()">
                    Continue with Free Content Only
                </button>
                <button class="auth-btn auth-btn-link" onclick="openCreatorInfo()">
                    Want to create and monetize your own content?
                </button>
            </div>
            <div class="loading-text" id="authLoadingText" style="display: none;">
                Processing...
            </div>
            <div style="margin-top: 20px; font-size: 12px; color: #888; text-align: center;">
                Powered by Unreality3D - The PayPal-Powered Creative Platform
            </div>
        </div>
    </div>

    <!-- Unity WebGL Container -->
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" width={{{ WIDTH }}} height{{{ HEIGHT }}}></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"></div>
    </div>
    <div id="unity-footer">
        <div id="unity-webgl-logo"></div>
        <div id="unity-build-title">{{{ PRODUCT_NAME }}}</div>
    </div>

    <!-- Firebase Configuration -->
    <script>
        // Firebase config (unreality3d production)
        const firebaseConfig = {
            apiKey: "AIzaSyC6VqQzGIzVvOWVyHmTYvOTEGRp9ky6BQA",
            authDomain: "unreality3d.firebaseapp.com",
            projectId: "unreality3d",
            storageBucket: "unreality3d.appspot.com",
            messagingSenderId: "292977872456",
            appId: "1:292977872456:web:6ae5df30f2e02c18c9bb23"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let unityInstance = null;
        let currentUser = null;
        let userType = 'visitor';

        // ===== PAYPAL INTEGRATION =====

        window.UnityRequestPayment = function(contentId, price) {
            console.log('Unity requesting payment for:', contentId, 'Price:', price);

            const popup = document.createElement('div');
            popup.id = 'unity-paypal-container';
            popup.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; justify-content: center; align-items: center;">
                    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; width: 90%;">
                        <h3 style="margin-top: 0; color: #333;">Complete Your Purchase</h3>
                        <p style="color: #666;">Content: ${contentId}</p>
                        <p style="color: #666;">Price: $${price}</p>
                        <div id="unity-paypal-buttons"></div>
                        <button onclick="closePayPalPopup()" style="margin-top: 15px; background: #ccc; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);

            try {
                paypal.Buttons({
                    createOrder: function(data, actions) {
                        return fetch('/api/payments/create-order', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                contentId: contentId,
                                amount: price,
                                userId: currentUser ? currentUser.uid : null
                            })
                        }).then(function(res) {
                            return res.json();
                        }).then(function(orderData) {
                            return orderData.id;
                        });
                    },
                    onApprove: function(data, actions) {
                        return fetch('/api/payments/capture-order', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                orderID: data.orderID,
                                contentId: contentId,
                                userId: currentUser ? currentUser.uid : null
                            })
                        }).then(function(res) {
                            return res.json();
                        }).then(function(details) {
                            console.log('Payment completed:', details);
                            closePayPalPopup();
                            if (unityInstance) {
                                unityInstance.SendMessage('FirebaseIntegration', 'OnPaymentComplete', 'true');
                            }
                        });
                    },
                    onError: function(err) {
                        console.error('PayPal error:', err);
                        closePayPalPopup();
                        if (unityInstance) {
                            unityInstance.SendMessage('FirebaseIntegration', 'OnPaymentComplete', 'false');
                        }
                    }
                }).render('#unity-paypal-buttons');

            } catch (error) {
                console.error('Payment request error:', error);
                if (unityInstance) {
                    unityInstance.SendMessage('FirebaseIntegration', 'OnPaymentComplete', 'false');
                }
            }
        };

        window.closePayPalPopup = function() {
            const popup = document.getElementById('unity-paypal-container');
            if (popup) {
                popup.remove();
            }
        };

        // ===== THREE-TIER AUTHENTICATION SYSTEM =====

        function showAuthOverlay() {
            document.getElementById('authOverlay').classList.remove('hidden');
        }

        function hideAuthOverlay() {
            document.getElementById('authOverlay').classList.add('hidden');
        }

        function showLoadingText(text) {
            const loadingElement = document.getElementById('authLoadingText');
            loadingElement.textContent = text;
            loadingElement.style.display = 'block';
        }

        function hideLoadingText() {
            document.getElementById('authLoadingText').style.display = 'none';
        }

        // PayPal login flow
        function startPayPalLogin() {
            showLoadingText('Redirecting to PayPal...');
            window.location.href = '/auth/paypal/login';
        }

        // Continue as visitor (limited access)
        function continueAsVisitor() {
            userType = 'visitor';
            hideAuthOverlay();

            if (unityInstance) {
                unityInstance.SendMessage('FirebaseIntegration', 'OnVisitorAccessGranted', 'true');
            }
        }

        // Open creator information
        function openCreatorInfo() {
            window.open('/quickstart.html', '_blank');
        }

        // Authentication state management
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                console.log('User authenticated:', user.email);
                hideAuthOverlay();
            } else {
                console.log('User not authenticated');
                // Automatically check content access and show overlay if needed
                setTimeout(() => {
                    window.UnityCheckContentAccess('test-area-1');
                }, 1000);
            }
            // Load Unity regardless for testing
            loadUnity();
        });

        // ===== UNITY LOADING FUNCTION - FIXED PATTERN =====
        function loadUnity() {
            var container = document.querySelector("#unity-container");
            var canvas = document.querySelector("#unity-canvas");
            var loadingBar = document.querySelector("#unity-loading-bar");
            var progressBarFull = document.querySelector("#unity-progress-bar-full");
            var fullscreenButton = document.querySelector("#unity-fullscreen-button");
            var warningBanner = document.querySelector("#unity-warning");

            function unityShowBanner(msg, type) {
                console.log('Unity Banner:', msg, type);
                function updateBannerVisibility() {
                    warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
                }
                var div = document.createElement('div');
                div.innerHTML = msg;
                warningBanner.appendChild(div);
                if (type == 'error') div.style = 'background: red; padding: 10px;';
                else {
                    if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
                    setTimeout(function() {
                        warningBanner.removeChild(div);
                        updateBannerVisibility();
                    }, 5000);
                }
                updateBannerVisibility();
            }

            var buildUrl = "Build";
            var loaderUrl = buildUrl + "/{{{ LOADER_FILENAME }}}";
            var config = {
                dataUrl: buildUrl + "/{{{ DATA_FILENAME }}}",
                frameworkUrl: buildUrl + "/{{{ FRAMEWORK_FILENAME }}}",
                codeUrl: buildUrl + "/{{{ CODE_FILENAME }}}",
#if MEMORY_FILENAME
                memoryUrl: buildUrl + "/{{{ MEMORY_FILENAME }}}",
#endif
#if SYMBOLS_FILENAME
                symbolsUrl: buildUrl + "/{{{ SYMBOLS_FILENAME }}}",
#endif
                streamingAssetsUrl: "StreamingAssets",
                companyName: "{{{ COMPANY_NAME }}}",
                productName: "{{{ PRODUCT_NAME }}}",
                productVersion: "{{{ PRODUCT_VERSION }}}",
                showBanner: unityShowBanner,
            };

            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                var meta = document.createElement('meta');
                meta.name = 'viewport';
                meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
                document.getElementsByTagName('head')[0].appendChild(meta);
                container.className = "unity-mobile";
                canvas.className = "unity-mobile";
            } else {
                canvas.style.width = "{{{ WIDTH }}}px";
                canvas.style.height = "{{{ HEIGHT }}}px";
            }

#if BACKGROUND_FILENAME
            canvas.style.background = "url('" + buildUrl + "/{{{ BACKGROUND_FILENAME }}}') center / cover";
#endif
            loadingBar.style.display = "block";

            var script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                createUnityInstance(canvas, config, (progress) => {
                    progressBarFull.style.width = 100 * progress + "%";
                }).then((instance) => {
                    unityInstance = instance;
                    loadingBar.style.display = "none";
                    if (fullscreenButton) {
                        fullscreenButton.onclick = () => {
                            unityInstance.SetFullscreen(1);
                        };
                    }
                }).catch((message) => {
                    alert(message);
                });
            };

            document.body.appendChild(script);
        }

        // ===== UNITY-WEB COMMUNICATION BRIDGE =====

        window.UnityCallTestFunction = function() {
            console.log('Unity called test function');
            // Test Firebase function or other backend
        };

        window.UnityCheckContentAccess = function(contentId) {
            console.log('Unity checking access for:', contentId);

            if (currentUser) {
                console.log('User authenticated, granting access');
                if (unityInstance) {
                    unityInstance.SendMessage('FirebaseIntegration', 'OnContentAccessResult', 'granted');
                }
            } else {
                console.log('User not authenticated, showing overlay');
                showAuthOverlay();
            }
        };
    </script>
</body>
</html>